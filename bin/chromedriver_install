#!/usr/bin/env bash
# Script to install Chrome and matching chromedriver at the system level for Linux
# This script is called by chromedriver_check when JS tests are detected

set -euo pipefail

echo "Installing Chrome and Chromedriver..."

# Update package list
sudo apt-get update

# Install dependencies
sudo apt-get install -y wget unzip libxss1

# Install Chrome if not installed
if ! command -v google-chrome &> /dev/null; then
  wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
  rm ./google-chrome-stable_current_amd64.deb
fi

# Get Chrome version
CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d. -f1)

# Download matching chromedriver version
wget -q "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_114" -O chrome_version
DRIVER_VERSION=$(cat chrome_version)
wget -q "https://chromedriver.storage.googleapis.com/${DRIVER_VERSION}/chromedriver_linux64.zip"
unzip -q chromedriver_linux64.zip

# Install chromedriver
sudo mv chromedriver /usr/local/bin/
sudo chmod +x /usr/local/bin/chromedriver

# Clean up
rm chrome_version chromedriver_linux64.zip

echo "Chrome version: $(google-chrome --version)"
echo "Chromedriver version: $(chromedriver --version)"
